#!/usr/bin/python
#!encoding=utf-8
import os
import re
import sys


if len(sys.argv) < 2:
    print 'Usage: <cmd> [options]'
    sys.exit(0)
cmd = sys.argv[1]
options = sys.argv[2:]

RE_FILE = re.compile('^File:\\s*(.*?)\\s+Status:\\s*(.*?)\\s*$')
RE_PATH = re.compile('^cvs server: Examining (.*)$')

if cmd == 'status':
    cmd_line = 'cvs status ' + ' '.join(options) + ' 2>&1'
    print cmd_line
    f = os.popen(cmd_line)
    filedir = ''
    while True:
        line = f.readline()
        if not line:
            break
        line = line.strip('\r\n')
        matchobj = RE_FILE.match(line)
        if matchobj:
            filename = matchobj.group(1)
            if filename.startswith('no file '):
                filename = filename[8:]
            filestatus = matchobj.group(2)
            status_table = {
                'Locally Modified':     'M',
                'Locally Removed':      'R',
                'Needs Checkout':       '!',
                'Locally Added':        'A',
                'Unknown':              '?',
            }
            filestatus = status_table.get(filestatus, None)
            if filestatus:
                print '%s %s%s' % (filestatus , filedir, filename)
        matchobj = RE_PATH.match(line)
        if matchobj:
            filedir =  matchobj.group(1).strip()
            if filedir != '' and filedir != '.':
                filedir += '/'
        if line.startswith('? '):
            print line

        

